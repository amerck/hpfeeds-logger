#!/bin/bash

trap "exit 130" SIGINT
trap "exit 137" SIGKILL
trap "exit 143" SIGTERM

source /etc/default/hpfeeds-logger
source /opt/hpfeeds-logger/hpfeeds-logger-env/bin/activate

cd /opt
if [[ ! -f ./hpfeeds-logger.cfg ]]
then

    # Check if we pulled in a value from the sysconfig file, and if not set a sane default
    HPFEEDS_HOST=${HPFEEDS_HOST:-'hpfeeds'}
    HPFEEDS_PORT=${HPFEEDS_PORT:-10000}
    IDENT=${IDENT:-'hpfeeds-logger'}
    SECRET=${SECRET:-`python -c 'import uuid;print str(uuid.uuid4()).replace("-","")'`}
    CHANNELS=${CHANNELS:-'amun.events,conpot.events,thug.events,beeswarm.hive,dionaea.capture,dionaea.connections,thug.files,beeswarn.feeder,cuckoo.analysis,kippo.sessions,cowrie.sessions,glastopf.events,glastopf.files,mwbinary.dionaea.sensorunique,snort.alerts,wordpot.events,p0f.events,suricata.events,shockpot.events,elastichoney.events,rdphoney.sessions,uhp.events'}
    FORMATTER_NAME=${FORMATTER_NAME:-'splunk'}
    FILELOG_ENABLED=${FILELOG_ENABLED:-false}
    LOG_FILE=${LOG_FILE:-'/var/log/hpfeeds-logger/chn-splunk.log'}
    SYSLOG_ENABLED=${SYSLOG_ENABLED:-false}
    SYSLOG_HOST=${SYSLOG_HOST:-'localhost'}
    SYSLOG_PORT=${SYSLOG_PORT:-514}
    SYSLOG_FACILITY=${SYSLOG_FACILITY:-"USER"}
    MONGODB_HOST=${MONGODB_HOST:-'mongodb'}
    MONGODB_PORT=${MONGODB_PORT:-27017}
    ROTATION_STRATEGY=${ROTATION_STRATEGY:-'size'}
    ROTATION_SIZE_MAX=${ROTATION_SIZE_MAX:-100}
    ROTATION_TIME_MAX=${ROTATION_TIME_MAX:-24}
    ROTATION_TIME_UNIT=${ROTATION_TIME_UNIT:-'h'}

    # Change into the HPFeeds dir, it's needed for hpfeeds scripts
    pushd /srv/hpfeeds/broker/

    # Generate config file for hpfeeds broker and try to register
    # Exit if failed
    python /srv/hpfeeds/broker/generateconfig.py unattended --mongo_host ${MONGODB_HOST} --mongo_port ${MONGODB_PORT} || exit 1
    python /srv/hpfeeds/broker/add_user.py "$IDENT" "$SECRET" "" "$CHANNELS" || exit 1

    # Change back to /opt directory
    popd

    # copy the example logger.json.example file and edit in our variables
    cp /opt/hpfeeds-logger/logger.json.example /opt/hpfeeds-logger/logger.json
    sed -i "s/\"host\": \"localhost\"/\"host\": \"${HPFEEDS_HOST}\"/g" /opt/hpfeeds-logger/logger.json
    sed -i "s/\"port\": 10000/\"port\": ${HPFEEDS_PORT}/g" /opt/hpfeeds-logger/logger.json
    sed -i "s/\"ident\": \"hpfeeds-logger\"/\"ident\": \"${IDENT}\"/g" /opt/hpfeeds-logger/logger.json
    sed -i "s|\"secret\": \"\"|\"secret\": \"${SECRET//\|/\\\|}\"|g" /opt/hpfeeds-logger/logger.json
    sed -i "s/\"formatter_name\": \"splunk\"/\"formatter_name\": \"${FORMATTER_NAME}\"/g" /opt/hpfeeds-logger/logger.json

    sed -i "s|\"filelog_enabled\": true|\"filelog_enabled\": ${FILELOG_ENABLED}|g" /opt/hpfeeds-logger/logger.json
    sed -i "s|\"log_file\": \"mhn-splunk-log.out\"|\"log_file\": \"${LOG_FILE}\"|g" /opt/hpfeeds-logger/logger.json
    sed -i "s|\"rotation_strategy\": \"size\"|\"rotation_strategy\": \"${ROTATION_STRATEGY}\"|g" /opt/hpfeeds-logger/logger.json
    sed -i "s|\"rotation_size_max\": \"100\"|\"rotation_size_max\": \"${ROTATION_SIZE_MAX}\"|g" /opt/hpfeeds-logger/logger.json
    sed -i "s|\"rotation_time_max\": \"24\"|\"rotation_time_max\": \"${ROTATION_TIME_MAX}\"|g" /opt/hpfeeds-logger/logger.json
    sed -i "s|\"rotation_time_unit\": \"h\"|\"rotation_time_unit\": \"${ROTATION_TIME_UNIT}\"|g" /opt/hpfeeds-logger/logger.json
    sed -i "s|\"rotation_backups\": \"3\"|\"rotation_backups\": \"${ROTATION_BACKUPS}\"|g" /opt/hpfeeds-logger/logger.json

    sed -i "s|\"syslog_enabled\": false|\"syslog_enabled\": ${SYSLOG_ENABLED}|g" /opt/hpfeeds-logger/logger.json
    sed -i "s|\"syslog_host\": \"localhost\"|\"syslog_host\": \"${SYSLOG_HOST}\"|g" /opt/hpfeeds-logger/logger.json
    sed -i "s|\"syslog_port\": 514|\"syslog_port\": ${SYSLOG_PORT}|g" /opt/hpfeeds-logger/logger.json
    sed -i "s|\"syslog_facility\": \"user\"|\"syslog_facility\": \"${SYSLOG_FACILITY}\"|g" /opt/hpfeeds-logger/logger.json

    # Please forgive me for this code
    OLD_IFS=${IFS}
    IFS='|'
    OUR_TEXT=`echo ${CHANNELS} | sed -e 's/^/\\\"/' -e 's/$/\\\"/' -e 's/,/\\\",\\\"/g' | tr ',' '\n' | sed -e 's/$/,/' -e '$s/,$//' -e 's/^/\\t/'`

    # Please also forgive me for using perl
    perl -i -p -000 -e "s/CHANNEL_VAR/${OUR_TEXT}/" /opt/hpfeeds-logger/logger.json

    IFS=${OLD_IFS}

fi

cd /opt/hpfeeds-logger/
echo "Starting hpfeeds-logger..."
export PYTHONPATH=/opt/hpfeeds-logger
exec python /opt/hpfeeds-logger/bin/hpfeeds-logger /opt/hpfeeds-logger/logger.json
